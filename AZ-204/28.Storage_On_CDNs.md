# Azure Content Delivery Networks

Azure Content Delivery Network (CDN) is a robust solution for delivering high-bandwidth content quickly and efficiently to users worldwide by leveraging a network of strategically located physical nodes. Here's a detailed look at how Azure CDN works and its benefits:

### Key Benefits
1. **Enhanced Performance and User Experience**:
   - Faster content delivery through edge caching.
   - Reduced load times for applications requiring multiple round-trips.

2. **Scalability**:
   - Handles high traffic loads efficiently.
   - Ideal for events like product launches where traffic spikes are common.

3. **Reduced Origin Server Load**:
   - Content served from edge servers reduces origin server traffic.
   - Distributes user requests across multiple edge locations.

### How Azure CDN Works
1. **Request Handling**:
   - A user requests a file using a special domain (e.g., `<endpoint name>.azureedge.net`).
   - DNS routes the request to the nearest Point of Presence (POP).

2. **Edge Server Caching**:
   - If the file isn't in the POP cache, it's fetched from the origin server.
   - The origin server can be Azure Web App, Cloud Service, Storage account, or any public web server.
   - The file is cached at the POP and served to the user.

3. **Subsequent Requests**:
   - Other users requesting the same file are served from the POP cache if the TTL hasn't expired.
   - This ensures faster response times and improved user experience.

### Requirements and Limitations
- **CDN Profiles**:
  - Create at least one CDN profile, a collection of CDN endpoints.
  - Use multiple profiles to organize endpoints by domain, application, etc.
  - Pricing is applied at the profile level.

- **Resource Limits**:
  - Limits on the number of CDN profiles, endpoints, and custom domains per subscription.
  - For detailed limits, refer to [CDN subscription limits](https://learn.microsoft.com/en-in/training/wwl-azure/develop-for-storage-cdns/media/azure-content-delivery-network.png).

### Key Features
- **Dynamic Site Acceleration**: Optimizes delivery of dynamic content.
- **CDN Caching Rules**: Customizable caching behavior.
- **HTTPS Custom Domain Support**: Secure content delivery.
- **Azure Diagnostics Logs**: Monitoring and troubleshooting.
- **File Compression**: Reduces bandwidth usage.
- **Geo-filtering**: Controls content delivery based on geographic location.

For a detailed comparison of features supported by different Azure CDN products, visit [Compare Azure CDN product features](https://learn.microsoft.com/en-us/azure/cdn/cdn-features).

### Visual Representation
You can see a visual explanation of how Azure CDN operates.

<img src="https://learn.microsoft.com/en-in/training/wwl-azure/develop-for-storage-cdns/media/azure-content-delivery-network.png" alt="Example Image" width="500" height="300">

Azure CDN is a powerful tool for enhancing the performance and scalability of your web applications, providing a smoother and faster user experience globally.

Controlling caching behavior in Azure Content Delivery Networks (CDNs) ensures that content delivery is both efficient and up-to-date. Here's a detailed guide on how to manage cache settings and TTL (time to live) in Azure CDN:

### Caching Mechanisms

Azure CDN provides two main caching mechanisms, which vary depending on the tier selected:

1. **Caching Rules**:
   - **Global Rules**: Apply to all content from a specified endpoint.
   - **Custom Rules**: Apply to specific paths and file extensions.

2. **Query String Caching**:
   - Configures how Azure CDN handles query strings in URLs.
   - No effect on non-cacheable files.

### Azure CDN Standard for Microsoft Tier Options

1. **Ignore Query Strings**:
   - Default mode.
   - First request with a query string passes to the origin server and is cached. Subsequent requests ignore query strings until TTL expires.

2. **Bypass Caching for Query Strings**:
   - Each query request is passed directly to the origin server with no caching.

3. **Cache Every Unique URL**:
   - Each unique URL is passed to the origin server, and the response is cached with its own TTL.
   - Inefficient for URLs with unique query parameters due to low cache-hit ratios.

### Changing Cache Settings

1. Go to the Endpoint pane in the Azure portal.
2. Select **Caching rules**.
3. Choose the desired caching option.
4. Click **Save**.

### Cache-Control and TTL

- The `Cache-Control` header in the HTTP response from the origin server determines the TTL.
- Default TTL values:
  - Generalized web delivery: 7 days
  - Large file optimizations: 1 day
  - Media streaming: 1 year

### Updating Content

1. **Version Strings**:
   - Include version strings in URLs to ensure users receive the latest asset versions.

2. **Purging Content**:
   - Purge cached content from edge nodes to refresh content on the next client request.
   - Methods:
     - Endpoint by endpoint or all endpoints simultaneously.
     - Specify file paths or use wildcards.
     - Azure CLI for purging:

       ```bash
       az cdn endpoint purge \
           --content-paths '/css/*' '/js/app.js' \
           --name ContosoEndpoint \
           --profile-name DemoProfile \
           --resource-group ExampleGroup
       ```

3. **Preloading Assets**:
   - Preload assets into an endpoint to improve user experience by prepopulating the cache:

     ```bash
     az cdn endpoint load \
         --content-paths '/img/*' '/js/module.js' \
         --name ContosoEndpoint \
         --profile-name DemoProfile \
         --resource-group ExampleGroup
     ```

### Geo-Filtering

- Allow or block content based on country/region codes.
- In Azure CDN Standard for Microsoft Tier, you can only allow or block the entire site.

By effectively managing these caching settings and strategies, you can ensure that your Azure CDN delivers content efficiently, reduces latency, and maintains the freshness of the content served to your users.

### Important Functions

1. **CdnManagementClient**: Initializes the CDN client for management operations.
   ```csharp
   CdnManagementClient cdn = new CdnManagementClient(new TokenCredentials(authResult.AccessToken))
   ```

2. **Profiles.ListByResourceGroup**: Lists all CDN profiles in a specified resource group.
   ```csharp
   var profileList = cdn.Profiles.ListByResourceGroup(resourceGroupName);
   ```

3. **Endpoints.ListByProfile**: Lists all CDN endpoints for a specified profile.
   ```csharp
   var endpointList = cdn.Endpoints.ListByProfile(p.Name, resourceGroupName);
   ```

4. **Profiles.Create**: Creates a new CDN profile.
   ```csharp
   cdn.Profiles.Create(profileName, profileParms, resourceGroupName);
   ```

5. **Endpoints.Create**: Creates a new CDN endpoint within a specified profile.
   ```csharp
   cdn.Endpoints.Create(endpointName, endpointParms, profileName, resourceGroupName);
   ```

6. **Endpoints.PurgeContent**: Purges content from a specified CDN endpoint.
   ```csharp
   cdn.Endpoints.PurgeContent(resourceGroupName, profileName, endpointName, new List<string>() { "/*" });
   ```
